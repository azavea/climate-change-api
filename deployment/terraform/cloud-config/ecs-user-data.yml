#cloud-config

packages:
    - awslogs

runcmd:
  - curl -o /etc/papertrail-bundle.pem https://papertrailapp.com/tools/papertrail-bundle.pem

write_files:
  - path: /etc/ecs/ecs.config
    permissions: 0644
    owner: root:root
    content: |
      ECS_CLUSTER=${ecs_cluster_name}
  - path: /etc/awslogs/awslogs.conf
    permissions: 0644
    owner: root:root
    content: |
      [general]
      state_file = /var/lib/awslogs/agent-state

      [/var/log/dmesg]
      file = /var/log/dmesg
      log_group_name = log${environment}ContainerInstance
      log_stream_name = dmesg/{instance_id}

      [/var/log/messages]
      file = /var/log/messages
      log_group_name = log${environment}ContainerInstance
      log_stream_name = messages/{instance_id}
      datetime_format = %b %d %H:%M:%S

      [/var/log/docker]
      file = /var/log/docker
      log_group_name = log${environment}ContainerInstance
      log_stream_name = docker/{instance_id}
      datetime_format = %Y-%m-%dT%H:%M:%S.%f

      [/var/log/ecs/ecs-init.log]
      file = /var/log/ecs/ecs-init.log.*
      log_group_name = log${environment}ContainerInstance
      log_stream_name = ecs-init/{instance_id}
      datetime_format = %Y-%m-%dT%H:%M:%SZ

      [/var/log/ecs/ecs-agent.log]
      file = /var/log/ecs/ecs-agent.log.*
      log_group_name = log${environment}ContainerInstance
      log_stream_name = ecs-agent/{instance_id}
      datetime_format = %Y-%m-%dT%H:%M:%SZ

  - path: /etc/init/awslogs.conf
    permissions: 0644
    owner: root:root
    content: |
      description "Configure and start CloudWatch Logs agent on Amazon ECS container instance"
      author "Amazon Web Services"
      start on started ecs
      script
          exec 2>>/var/log/ecs/cloudwatch-logs-start.log
          set -x
          until curl -s http://localhost:51678/v1/metadata
          do
              sleep 1
          done
          service awslogs start
          chkconfig awslogs on
      end script

  - path: /etc/statsite/librato.ini
    permissions: 0644
    owner: root:root
    content: |
      [librato]
      email = ${librato_climate_email}
      token = ${librato_climate_token}
      floor_time_secs = 60

  - path: /etc/statsite/statsite.cfg
    permissions: 0644
    owner: root:root
    content: |
      [statsite]
      port = 8125
      udp_port = 8125
      log_level = INFO
      flush_interval = 60
      timer_eps = 0.01
      set_eps = 0.02
      stream_cmd = python /usr/libexec/statsite/librato.py /etc/statsite/librato.ini
      daemonize = 0
      [histogram_api]
      prefix=api
      min=0
      max=100
      width=5
      [histogram_default]
      prefix=
      min=0
      max=200
      width=20
